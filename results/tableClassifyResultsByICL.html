<!DOCTYPE html>
<meta charset="utf-8">
<style type="text/css">

table {
  border-collapse: collapse;
  font: 10px sans-serif;
  width: 720px;
}

th {
  font-weight: normal;
  text-align: right;
  padding-right: 6px;
  min-width: 43px;
}

thead td {
  cursor: s-resize;

}

tbody tr:first-child td {
  padding-top: 2px;
}

tbody td {
  padding: 0;
  border-left: solid 1px #000;
}

tbody rect {
  fill: steelblue;
}

tbody tr:hover rect {
  fill: brown;
}

#icldropdowndiv{
    margin: 20px;
}

</style>

<div id="icldropdowndiv">
    <label id="icldropdownlabel" >Select an ICL</label>
    <select id="icldropdown" onchange="OnSetICL(this)">Fetching ICL names....</select> 
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="../vendor/jquery/jquery-2.1.0.min.js"></script>
<script>


var populateIclDropDown = function(iclToTaskIds) {
    var dd = document.getElementById("icldropdown");
    
    // empty the current options
    var len = dd.options.length;
    for (var i = 0; i < len ; ++i) {
        dd.options[i] = null;
    };
    
    // add the new ones
    Object.keys(iclToTaskIds).forEach(function(key){
        dd.options[dd.options.length] = new Option(key, key);
    });
}


var populateTable = function(columnNames, objArr) {
    
    var headerRow = d3.selectAll("thead tr")
        .data(columnNames)
        .enter()
        .append("th")
        .text(function(d) { return d; })
        .on("click", function(k) {
            // magic! sorts and redisplays the table
            bodyRows.sort(function(a, b) { return a[k] - b[k]; });
        });
          
    var bodyRows = d3.selectAll("tbody tr")
        .data(objArr)
        .enter()
        .append("tr");
        
    bodyRows.selectAll("td")
        .data(function(d) { return columnNames.map(function(k) { return d[k]; }) })
        .enter()
        .append("td")
        .text(function(d) {return d;});
}


var populateTestTable = function() {

    var columnNames = ["apples", "peaches", "pumpkin_pie"];
    
    var testme = [
        { title:"quantity", apples: 5, peaches: 3, pumpkin_pie:12 },
        { title:"volume", apples: 1, peaches:7, pumpkin_pie: 3},
        { title:"hours", apples: 3, peaches:12, pumpkin_pie: 5},
    ];
    
    populateTable(columnNames, testme);
}

var handleClassifyTasksJson = function(tasksJson) {

    var result = jQuery.parseJSON(tasksJson);
    var rows = result.rows;
    
    // build array of iclnames with associated array of all tasksIds that have that icl
    rows.forEach(function(row) {
        
        iclToTaskIds[row.value.image_classify_list] = iclToTaskIds[row.value.image_classify_list] || [];
        iclToTaskIds[row.value.image_classify_list].push(row.value._id);
        
        taskIdToUser[row.value._id] = row.key;
    });

    populateIclDropDown(iclToTaskIds);
}


var OnSetICL=function(sel) {
    console.log ("ICL changed to: " + sel.value);
    
    // for each task id, get the results and populate a row
    // table: imageClassifyList are the rows, users (but really taskIds) are the columns
    //$.get(classifyResultsUrl, populateTable);
    populateTestTable();
}

var dbviewUrl = "http://ec2-54-152-40-100.compute-1.amazonaws.com:5984/rop_images/_design/basic_views/_view/";

var classifyTasksViewname = "classify_tasks";
var classifyResultsViewname = "classifyResults";

var classifyTasksUrl = dbviewUrl + classifyTasksViewname;
var classifyResultsUrl = dbviewUrl + classifyResultsViewname;

// hashes
var iclToTaskIds = [];
var taskIdToUser = [];

$.get(classifyTasksUrl, handleClassifyTasksJson);


</script>
