<!DOCTYPE html>
<meta charset="utf-8">
<style type="text/css">

table {
  border-collapse: collapse;
  font: 10px sans-serif;
  width: 720px;
}

th {
  font-weight: normal;
  text-align: right;
  padding-right: 6px;
  min-width: 43px;
}

thead td {
  cursor: s-resize;

}

tbody tr:first-child td {
  padding-top: 2px;
}

tbody td {
  padding: 0;
  border-left: solid 1px #000;
}

tbody rect {
  fill: steelblue;
}

tbody tr:hover rect {
  fill: brown;
}

#icldropdowndiv{
    margin: 20px;
}

</style>

<div id="icldropdowndiv">
    <label id="icldropdownlabel" >Select an ICL</label>
    <select id="icldropdown" onchange="OnSetICL(this)">Fetching ICL names....</select> 
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="../vendor/jquery/jquery-2.1.0.min.js"></script>
<script>


var populateIclDropDown = function(iclToTaskIds) {
    var dd = document.getElementById("icldropdown");
    
    // empty the current options
    var len = dd.options.length;
    for (var i = 0; i < len ; ++i) {
        dd.options[i] = null;
    };
    
    // add the new ones
    Object.keys(iclToTaskIds).forEach(function(key){
        dd.options[dd.options.length] = new Option(key, key);
    });
}


var populateTable = function(columnNames, objArr) {
    
    var headerRow = d3.selectAll("thead tr")
        .data(columnNames)
        .enter()
        .append("th")
        .text(function(d) { 
            return taskIdToUser[d]; })
        .on("click", function(k) {
            // magic! sorts and redisplays the table
            bodyRows.sort(function(a, b) { return a[k] - b[k]; });
        });
          
    var bodyRows = d3.selectAll("tbody tr")
        .data(objArr)
        .enter()
        .append("tr");
        
    bodyRows.selectAll("td")
        .data(function(d) { return columnNames.map(function(k) { 
            return d.task === k ? d.diag : null; }) 
        })
        .enter()
        .append("td")
        .text(function(d) {
            return d;});
}


var populateTestTable = function() {

    var columnNames = ["apples", "peaches", "pumpkin_pie"];
    
    var testme = [
        { title:"quantity", apples: 5, peaches: 3, pumpkin_pie:12 },
        { title:"volume", apples: 1, peaches:7, pumpkin_pie: 3},
        { title:"hours", apples: 3, peaches:12, pumpkin_pie: 5},
    ];
    
    populateTable(columnNames, testme);
}


var populateResultsTable = function(iclname) {

    // build an array of objects 
    // rows are images (for the moment indexes)
    // columns are users
    var userNames = [];
    Object.keys(taskIdToUser).forEach(function(id) {
        var unm = taskIdToUser[id];
        if (userNames.indexOf(unm) === -1){
            userNames.push(unm);
        }      
    }); 
//    userNames.forEach(function(unm) { console.log (unm);});
    
    var columnNames = iclToTaskIds[iclname];
    populateTable(columnNames, taskResults);
    
}

var appendListsObj = function(listJson) {

    var dbresult = jQuery.parseJSON(listJson);
    
    // assert we only got one row, that is, one and only one list per icl
    if (dbresult.rows.length != 1) {
        alert ("bad number of lists for icl");
    }
    
    var dbresRow = dbresult.rows[0];
    
    iclToImageIdList[dbresRow.key] = dbresRow.value.list;
    //console.log(dbresRow.key + " " + dbresRow.value.list.length);
}

var handleClassifyTasksJson = function(tasksJson) {

    var result = jQuery.parseJSON(tasksJson);
    var rows = result.rows;
    
    // build array of iclnames with associated array of all tasksIds that have that icl
    rows.forEach(function(row) {
        
        iclToTaskIds[row.value.image_classify_list] = iclToTaskIds[row.value.image_classify_list] || [];
        iclToTaskIds[row.value.image_classify_list].push(row.value._id);
        
        taskIdToUser[row.value._id] = row.key;
    });
    
    // for each icl, go get the actual list
    Object.keys(iclToTaskIds).forEach(function(iclname) {
        var listUrl = classifyListsUrl + "?key=\"" + iclname + "\"";
        $.get(listUrl, appendListsObj);
    });

    populateIclDropDown(iclToTaskIds);
}
    

var appendResultsObj = function(resJson) {

    var dbresult = jQuery.parseJSON(resJson);
    
    
    
    dbresult.rows.forEach(function(row) {
        var task = row.value.task;
        var taskIdx = row.value.task_idx;
        var imageUrl = row.value.image0;
        var diag = row.value.diagnosis;
        var user = row.value.user;
        // also date and user ... not needed 
        
        taskIdToResults[task] = taskIdToResults[task] || {};
        
        // assert we've not seen this idx before, or that we are reloading the same value
        var thisRes = taskIdToResults[task][taskIdx];
        if (thisRes) {
            if (thisRes.image != imageUrl ||
                thisRes.user != user      ||
                thisRes.diag != diag)
            alert ("repeated task id with a different result: taskidx: " + taskIdx + "taskid: " + task );
        }
        
        // recording images is redundant, todo - taskIdTaskIdxToImage
        taskIdToResults[task][taskIdx] = {image: imageUrl, user: user, diag: diag};
        taskResults.push({task: task, taskIdx: taskIdx, image: imageUrl, user: user, diag: diag});
    });
    
}
    
var buildClassifyResultsObj = function(iclname){

    var taskIds = iclToTaskIds[iclname];

    var deferreds = [];
    var deferred;
    taskIds.forEach(function(taskId) {
        
        var listUrl = classifyResultsUrl + "?key=\"" + taskId + "\"";
        deferred = $.get(listUrl, appendResultsObj);
        deferreds.push(deferred);
    });
    
    return deferreds;
}

var OnSetICL=function(sel) {
    console.log ("ICL changed to: " + sel.value);
    
    //populateTestTable();
    taskResults = [];
    
    // build up the results data for this icl
    var deferreds = buildClassifyResultsObj(sel.value);
    $.when.apply($, deferreds).done(function() {
        populateResultsTable(sel.value);
    });
}

var dbviewUrl = "http://ec2-54-152-40-100.compute-1.amazonaws.com:5984/rop_images/_design/basic_views/_view/";

var classifyTasksViewname = "classify_tasks";
var classifyResultsViewname = "classifyResults";
var classifyListsViewname = "image_classify_lists";

var classifyTasksUrl = dbviewUrl + classifyTasksViewname;
var classifyResultsUrl = dbviewUrl + classifyResultsViewname;
var classifyListsUrl = dbviewUrl + classifyListsViewname;

// hashes
var iclToTaskIds = {};
var iclToImageIdList = {};
var taskIdToUser = {};
var taskIdToResults = {};
var taskResults = [];

// find the list of icls from the DB and populate the drop down
$.get(classifyTasksUrl, handleClassifyTasksJson);


</script>
